!function(a,b,c,d){"use strict";function e(b,c){this.$container=a(b),this.options=c=a.extend(g,c||{})}var f,g={placeholder:"请自觉遵守互联网相关的政策法规，严禁发布色情、暴力、反动的言论。",wbAppKey:"",commentAble:!0,announcement:"",pageNumber:10,childrenNumber:10,threadKey:"",title:""},h=0,i=0,j=!1,k={};e.prototype={constructor:e,init:function(){this.currentPage=0,this.renderInitHtml(),this.bindEvents()},renderInitHtml:function(){var a,b="https://api.weibo.com/oauth2/authorize?client_id="+this.options.wbAppKey+"&response_type=code&redirect_uri="+location.origin+"/wbconnect?back_uri="+location.origin+location.pathname,c="";this.options.commentAble?a='<div class="baffle">微博<a class="b-btn btn-open-mini-Login" href="'+b+'">登录</a>后发表评论 (・ω・)</div>':(a='<div class="baffle">'+this.options.announcement+"</div>",c="not-allow");var d='<div class="spruche-comment"><div class="sc-head"><span class="sc-head-t result">--</span><span class="sc-head-t">评论</span></div><div class="comm" id="spComment"><div class="sc-comment"><div class="sc-comment-header"><div class="tabs-order"><ul><li class="on" data-sort="0">全部评论</li></ul></div><div class="header-page paging-box"><span class="result">共--页</span></div></div><div class="comment-send no-login '+c+'"><div class="user-face"><img class="user-head" src="/images/pic/defaulthead1.png"></div><div class="textarea-container">'+a+'<textarea class="comment-textarea" cols="80" name="msg" rows="5" placeholder="'+this.options.placeholder+'" class="ipt-txt"></textarea><button type="submit" class="comment-submit" data-status="ready" data-rid="0" data-pid="0" data-type="parents">发表评论</button></div></div><div class="comment-list" data-status="loading"><div class="comment-list-status">loading...</div></div></div></div><div class="tips-container"></div></div>';this.$container.html(d),this.getComments(),this.getUserInfo()},ajaxFunc:function(b,c,d){a.ajax({type:"POST",url:b,dataType:"json",traditional:!0,data:{form:JSON.stringify(c)},success:function(a){d(a)}.bind(this),error:function(){console.warn("评论加载失败！")}.bind(this)})},getUserInfo:function(){if(a.cookie("uid")||a.cookie("token")){var b={uid:a.cookie("uid"),token:a.cookie("token")},c=this.$container;this.options.placeholder;this.ajaxFunc("/users/profile",b,function(a){if(0===a.retCode){k=a.retData;var b=/^http:\/\//g,d=a.retData.head_img;b.test(d)&&(d=d.replace(/^http/g,"https")),k.head_img=d,c.find(".user-face .user-head").attr("src",d),j=!0,c.find(".comment-send").removeClass("no-login"),k=a.retData}})}},getQueryStringByName:function(a){var b=location.search.match(new RegExp("[?&]"+a+"=([^&]+)","i"));return null===b||b.length<1?"":b[1]},getComments:function(){var a={threadKey:this.options.threadKey,pageNumber:this.options.pageNumber,childrenNumber:this.options.childrenNumber},b=this.$container,c=this;this.ajaxFunc("/comments/getcomments",a,function(a){if(0!==a.retCode)b.find(".comment-list").attr("data-status","failed"),b.find(".comment-list .comment-list-status").html("英灵召唤失败，再来一次十连抽(・ω・)");else{b.find(".comment-list").attr("data-status","success");var d=c.renderCommentsHtml(a.retData.comments);b.find(".comment-list").html(d),b.find(".sc-head .sc-head-t.result").text(a.retData.page.count);var e=Math.ceil(a.retData.page.amount/c.options.pageNumber);c.setPage(e,1),h=1,i=e}})},getThridToken:function(){var c=this.getQueryStringByName("code"),d=this.getQueryStringByName("back_uri");if(""!==c){var e={code:c,redirectUri:location.origin};this.ajaxFunc("/wbconnect",e,function(c){if(0===c.retCode){var e=c.retData;a.cookie("uid",e.id,{expires:new Date(e.expires),path:"/"}),a.cookie("username",e.username,{expires:new Date(e.expires),path:"/"}),a.cookie("type",e.type,{expires:new Date(e.expires),path:"/"}),a.cookie("token",e.token,{expires:new Date(e.expires),path:"/"}),b.location.href=d}else console.warn("召唤失败!")})}},renderCommentsHtml:function(a){for(var b='<ul class="comments-ul">',c=0;c<a.length;c++){var d='<ul class="reply-box" data-amount="'+a[c].childrenAmount+'">';d+=this.renderChildrenHtml(a[c].children),a[c].childrenAmount>3&&(d+='<div class="view-more">还有<b>'+(a[c].childrenAmount-3)+'</b>条回复, <a class="btn-more" data-pid="'+a[c].id+'">点击查看</a></div>'),d+="</ul>";var e,f,g="";1===a[c].type?(e=a[c].ds_dafault_img,f=a[c].ds_username):(e=a[c].head_img,f=a[c].username),a[c].wb_id&&(g='href="http://weibo.com/u/'+a[c].wb_id+'" target="_blank"'),e=e.replace(/^http:\/\//g,"https://");var h=this.formatDate(a[c].create_time),i=a[c].message.replace(/<(?:.|\s)*?>/g,"");b+='<li class="list-item reply-wrap" data-id="'+a[c].id+'" data-uid="'+a[c].user_id+'"><div class="user-face" data-usercard-mid="'+a[c].id+'"><a '+g+'><img src="'+e+'" alt=""></a></div><div class="con no-border"><div class="user"><a data-usercard-mid="'+a[c].user_id+'" class="name " '+g+">"+f+'</a></div><p class="text">'+i+'</p><div class="info"><span class="time">'+h+'</span><span class="like " data-amount="'+a[c].like_amount+'" data-id="'+a[c].id+'"><i></i><span>('+a[c].like_amount+')</span></span><span class="hate " data-amount="'+a[c].hate_amount+'" data-id="'+a[c].id+'"><i></i><span>('+a[c].hate_amount+')</span></span><span class="reply btn-hover">参与回复</span><span class="report btn-hover btn-hide" data-id="'+a[c].id+'">举报</span></div>'+d+'<div class="comment-send "><div class="user-face"><img class="user-head" src="/images/pic/defaulthead1.png"></div><div class="textarea-container"><textarea class="comment-textarea" cols="80" name="msg" rows="5" placeholder="'+this.options.placeholder+'" class="ipt-txt"></textarea><button type="submit" class="comment-submit" data-rid="" data-pid="" data-status="ready" data-type="children">发表评论</button></div></div></div></li>'}return b+="</ul>"},renderChildrenHtml:function(a){for(var b="",c=0;c<a.length;c++){var d,e,f="";1===a[c].type?(d=a[c].ds_dafault_img,e=a[c].ds_username):(d=a[c].head_img,e=a[c].username),a[c].wb_id&&(f='href="http://weibo.com/u/'+a[c].wb_id+'" target="_blank"'),d=d.replace(/^http:\/\//g,"https://");var g=this.formatDate(a[c].create_time),h=a[c].message.replace(/<(?:.|\s)*?>/g,"");b+='<li class="reply-item reply-wrap" data-id="'+a[c].id+'" data-uid="'+a[c].user_id+'"><a class="reply-face" '+f+'><img src="'+d+'" alt=""></a><div class="reply-con"><div class="user"><a data-usercard-mid="'+a[c].user_id+'" class="name " '+f+">"+e+'</a><span class="text-con">&nbsp;&nbsp;'+h+'</span></div><div class="info"><span class="time">'+g+'</span><span class="like " data-amount="'+a[c].like_amount+'" data-id="'+a[c].id+'"><i></i><span>('+a[c].like_amount+')</span></span><span class="reply btn-hover" data-username="'+e+'">回复</span><span class="report btn-hover btn-hide-re" data-id="'+a[c].id+'">举报</span></div></div></li>'}return b},formatDate:function(a){var b=function(a){return a<10?"0"+a:a},c="",d=new Date,e=new Date(a),f=Math.ceil((d-e)/1e3);if(f>=0&&f<60)c=f+"秒前";else if(f>=60&&f<3600)c=Math.round(f/60)+"分钟前";else if(f>=3600&&f<86400)c=Math.round(f/3600)+"小时前";else if(f>=86400&&f<259200)c=Math.round(f/86400)+"日前";else{var g=e.getFullYear(),h=b(parseInt(e.getMonth()+1,10)),i=b(parseInt(e.getDate(),10)),j=b(parseInt(e.getHours(),10)),k=b(parseInt(e.getMinutes(),10)),l=b(parseInt(e.getSeconds(),10));c=g+"-"+h+"-"+i+"  "+j+":"+k+":"+l}return c},setPage:function(a,b){this.$container.find(".header-page .result").text("共 "+a+" 页");for(var c='<span class="current">'+b+"</span>",d=1;d<=3;d++)b-d>1&&(c='<span class="tcd-number">'+(b-d)+"</span>"+c),b+d<a&&(c+='<span class="tcd-number">'+(b+d)+"</span>");b-4>1&&(c='<span class="dian">...</span>'+c),b>1&&(c='<span class="prev">上一页</span><span class="tcd-number">1</span>'+c),b+4<a&&(c+='<span class="dian">...</span>'),b<a&&(c+='<span class="tcd-number">'+a+'</span><span class="next">下一页</span>'),c='<span class="result">共 '+a+" 页</span>"+c,this.$container.find(".sc-comment .sc-comment-header .header-page.paging-box").html(c)},renderPageHtml:function(a,b,c){for(var d='<span class="current" data-pid="'+c+'">'+b+"</span>",e=1;e<=3;e++)b-e>1&&(d='<span class="tcd-number" data-pid="'+c+'">'+(b-e)+"</span>"+d),b+e<a&&(d+='<span class="tcd-number" data-pid="'+c+'">'+(b+e)+"</span>");return b-4>1&&(d='<span class="dian">...</span>'+d),b>1&&(d='<span class="prev" data-pid="'+c+'">上一页</span><span class="tcd-number" data-pid="'+c+'">1</span>'+d),b+4<a&&(d+='<span class="dian" data-pid="'+c+'">...</span>'),b<a&&(d+='<span class="tcd-number" data-pid="'+c+'">'+a+'</span><span class="next" data-pid="'+c+'">下一页</span>'),d='<span class="result">共 '+a+" 页</span>"+d,d='<div class="paging-box">'+d,d+="</div>"},getPageChildren:function(a,b){var c=this;this.ajaxFunc("/comments/getChildrenCommentsByPage",a,function(d){if(0===d.retCode){var e=c.renderChildrenHtml(d.retData.comments.children);b.html(e);var f=c.renderPageHtml(Math.ceil(d.retData.comments.childrenAmount/c.options.childrenNumber),a.page,a.parents);b.append(f)}})},showTips:function(a){clearTimeout(f);var b=this.$container.find(".tips-container");b.text(a),b.slideDown("fast"),f=setTimeout(function(){b.slideUp("fast")},1500)},bindEvents:function(){var b=this.ajaxFunc,c=this.$container,e=this.options,f=this;c.on("click",".spruche-comment .sc-comment-header .tcd-number",function(){var d=parseInt(a(this).text(),10),g={threadKey:e.threadKey,pageNumber:e.pageNumber,childrenNumber:e.childrenNumber,target:d};b("/comments/getCommentsByPage",g,function(a){if(0!==a.retCode);else{var b=f.renderCommentsHtml(a.retData.comments);c.find(".comment-list").html(b),h=d,f.setPage(i,h)}})}),c.on("click",".spruche-comment .sc-comment-header .prev",function(){var a=h-1;if(!(a<1)){var d={threadKey:e.threadKey,pageNumber:e.pageNumber,childrenNumber:e.childrenNumber,target:a};b("/comments/getCommentsByPage",d,function(b){if(0!==b.retCode);else{var d=f.renderCommentsHtml(b.retData.comments);c.find(".comment-list").html(d),h=a,f.setPage(i,a)}})}}),c.on("click",".spruche-comment .sc-comment-header .next",function(){var a=h+1;if(!(a>i)){var d={threadKey:e.threadKey,pageNumber:e.pageNumber,childrenNumber:e.childrenNumber,target:a};b("/comments/getCommentsByPage",d,function(b){if(0!==b.retCode);else{var d=f.renderCommentsHtml(b.retData.comments);c.find(".comment-list").html(d),h=a,f.setPage(i,a)}})}}),c.on("click",".comment-submit",function(){var g=a(this).prev(".comment-textarea");if(!e.commentAble)return void f.showTips("主人还不准你调戏评论框～");if(!j)return void f.showTips("登陆后才可以发表评论哦～");var h=g.val();if(""===h)return void f.showTips("啥都没有说...");if(h.length>1e3)return void f.showTips("1000字以内，乌螺塞 (╬￣皿￣)凸");if("ready"!==a(this).attr("data-status"))return void f.showTips("正在发送，骚年 (╬￣皿￣)凸");a(this).attr("data-status","sending");var i=a(this),k=a(this).attr("data-type"),l=parseInt(a(this).attr("data-pid")),m={message:h,threadKey:e.threadKey,title:e.title,userAgent:d.userAgent,pid:l,rid:parseInt(a(this).attr("data-rid"))};b("/comments/sendComments",m,function(a){if(0===a.retCode){if("parents"===k)f.getComments();else{var b=i.parents(".comment-send").prev(".reply-box"),d=i.parents(".list-item"),h=parseInt(b.attr("data-amount"),10);if(h<3)f.getComments();else{d.removeClass("open-reply");var j={parents:l,childrenNumber:e.childrenNumber,page:Math.ceil((h+1)/e.childrenNumber)};f.getPageChildren(j,b);var m=c.find(".sc-head .sc-head-t.result");m.text(parseInt(m.text(),10)+1)}}g.val(""),i.attr("data-status","ready")}else i.attr("data-status","ready"),f.showTips(a.retMsg)})}),c.on("click",".list-item .con>.info>.reply",function(){var b=a(this).parents(".list-item");if(b.hasClass("open-reply"))return void b.removeClass("open-reply");if(!e.commentAble)return void f.showTips("主人还不准你调戏评论框～");if(!j)return void f.showTips("登陆后才可以参与回复评论哦～");c.find(".list-item").removeClass("open-reply"),b.addClass("open-reply"),b.find(".comment-send .user-head").attr("src",k.head_img);var d=b.find(".comment-send .textarea-container .comment-submit");d.attr("data-pid",b.attr("data-id")),d.attr("data-rid",b.attr("data-id"))}),c.on("click",".reply-item .reply-con .info .reply",function(){var b=a(this).parents(".list-item");if(!e.commentAble)return void f.showTips("主人还不准你调戏评论框～");if(!j)return void f.showTips("登陆后才可以参与回复评论哦～");c.find(".list-item").removeClass("open-reply"),b.addClass("open-reply"),b.find(".comment-send .user-head").attr("src",k.head_img);var d=b.find(".comment-send .textarea-container .comment-submit"),g=a(this).parents(".reply-item");a(this).parents(".list-item").find(".comment-textarea").val("回复 @"+a(this).attr("data-username")+"："),d.attr("data-pid",b.attr("data-id")),d.attr("data-rid",g.attr("data-id"))}),c.on("click",".list-item .reply-box .view-more .btn-more",function(){var b=parseInt(a(this).attr("data-pid"),10),c=1,d={parents:b,childrenNumber:e.childrenNumber,page:c},g=a(this).parents(".reply-box");f.getPageChildren(d,g)}),c.on("click",".spruche-comment .reply-box .paging-box .tcd-number",function(){var b=parseInt(a(this).attr("data-pid"),10),c=parseInt(a(this).text(),10),d={parents:b,childrenNumber:e.childrenNumber,page:c},g=a(this).parents(".reply-box");f.getPageChildren(d,g)}),c.on("click",".spruche-comment .reply-box .paging-box .prev",function(){var b=a(this).siblings(".current"),c=parseInt(b.text(),10);if(c-=1,!(c<0)){var d=parseInt(a(this).attr("data-pid"),10),g=a(this).parents(".reply-box"),h={parents:d,childrenNumber:e.childrenNumber,page:c};f.getPageChildren(h,g)}}),c.on("click",".spruche-comment .reply-box .paging-box .next",function(){var b=a(this).siblings(".current"),c=parseInt(b.text(),10);c+=1;var d=parseInt(a(this).siblings(".result").text(),10);if(!(c>d)){var g=parseInt(a(this).attr("data-pid"),10),h=a(this).parents(".reply-box"),i={parents:g,childrenNumber:e.childrenNumber,page:c};f.getPageChildren(i,h)}}),c.on("click",".like",function(){if(!j)return void f.showTips("登陆后才可以给评论点赞哦～");var b=a(this).find("span"),c=a(this).next(".hate").find("span"),d={threadKey:e.threadKey,cid:parseInt(a(this).attr("data-id"),10)};f.ajaxFunc("/comments/like",d,function(a){0===a.retCode&&(b.text("("+a.retData.amount.like+")"),c.text("("+a.retData.amount.hate+")"))})}),c.on("click",".hate",function(){if(!j)return void f.showTips("登陆后才可以给评论打差评哦～");var b=a(this).prev(".like").find("span"),c=a(this).find("span"),d={threadKey:e.threadKey,cid:parseInt(a(this).attr("data-id"),10)};f.ajaxFunc("/comments/hate",d,function(a){0===a.retCode&&(b.text("("+a.retData.amount.like+")"),c.text("("+a.retData.amount.hate+")"))})}),c.on("click",".report",function(){return j?void f.showTips("确实收到了呢～"):void f.showTips("登陆后才能举报～")})}},b.Servant=e}(jQuery,window,document,navigator);